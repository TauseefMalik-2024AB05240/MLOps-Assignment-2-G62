name: M4 CD Deployment

on:
  workflow_run:
    workflows: ["M3 CI Pipeline"]
    types:
      - completed

jobs:
  deploy:
    if: ${{ github.event.workflow_run.conclusion == 'success' }}
    runs-on: ubuntu-latest
    environment: production

    steps:

    - name: Checkout Repository
      uses: actions/checkout@v4

    - name: Login to Docker Hub
      uses: docker/login-action@v3
      with:
        username: ${{ secrets.DOCKER_USERNAME }}
        password: ${{ secrets.DOCKER_PASSWORD }}

    - name: Pull Latest Image
      run: |
        docker pull ${{ secrets.DOCKER_USERNAME }}/cats-dogs-api:latest

    - name: Deploy using Docker Compose
      run: |
        export DOCKER_USERNAME=${{ secrets.DOCKER_USERNAME }}
        docker compose up -d

    - name: Wait for Service to Start
      run: sleep 15

    - name: Smoke Test - Health Endpoint
      run: |
        curl -f http://localhost:8000/health || exit 1

    - name: Smoke Test - Predict Endpoint
      run: |
        curl -X POST http://localhost:8000/predict \
          -F "file=@tests/sample.jpg" || exit 1

    - name: Shutdown Containers
      if: always()
      run: docker compose down
